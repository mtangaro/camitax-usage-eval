# camitax-usage-eval

Camitax is run by default with the docker profile, therefore, while nextflow is running (java), tools belonging to camitax are run as Docker containers, thus making it difficult to monitor the resources consumed by the workflow.

Indeed just tracking the resources used by nextflow would lead to ignoring the consumption of RAM and CPU due to containers, heavily underestimating the resources required to run camitax.

In the following, we are using the ``docker stats`` command to montor cpu and RAM exploited by camitax Dockers.

## Strategy

The idea is to monitor all Docker containers generated by CAMITAX, with the ``docker stats`` command, sampling the CPU and RAM usage saving the results in a .csv file.

> [!NOTE]
> For this strategy to work, the only containers running must be those of camitax so as not to distort the measurement. We isolated the environment using a Virtual Machine, running only CAMITAX.

The script ``compute_docker_total_stats.sh`` is responsible for running the ``docker stats`` command, sum RAM and CPU consumption for each docker running, return these values in the form ``$SUM_CPU|$SUM_MEM``. Since ``docker stats`` can't track the total amount of RAM and CPU used by contaienrs, but is justa able to display it for each container running, the script clean the ``docker stats`` output and computes RAM and CPU usage by summing the contribution of each Docker.

The script ``update_camitax_metrics.py`` is responsible to run ``compute_docker_total_stats.sh`` until the nextflow workflow is running, sampling the CPU and RAM consumption, and save the measures in CSV format. It takes the nextflow PID as input, with the ``-p`` option, so that once the nextflow run is ended, the data are save in the ``camitax_metrics.csv`` file.

## Prerequisites

The python script needs ``pandas`` to fill dataframes.

```
pip install -r requirements.txt
```

## Usage

In the following we describe the three steps to perform the measure

1. Nextflow can be run in backgroud mode or not, depending on the run time length. Run nextflow with the command:

``nextflow run CAMI-challenge/CAMITAX -profile docker --db /path/to/db --i /path/to/input/data --x fa -c /data/CAMITAX/nextflow.config -bg``

2. Nextflow is a java application so its PID can be easily retrieved with:

```
ps -aux | grep java
```

or

```
ps -aux | grep nextflow
```

3. Run the monitoring script:
